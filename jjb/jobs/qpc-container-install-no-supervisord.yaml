- job-template:
    name: 'qpc-{release}-nosupervisord-install-{distro}'
    node: '{distro}-os'
    triggers:
        - timed: '@midnight'
    scm:
        - git:
            url: https://github.com/quipucords/ci.git
            basedir: ci
            skip-tag: true
            branches:
              - master
    wrappers:
        - inject:
            properties-content: |
                DISTRO={distro}
                RELEASE={release}
        - credentials-binding:
            - file:
                credential-id: 4c692211-c5e1-4354-8e1b-b9d0276c29d9
                variable: ID_JENKINS_RSA
        - ssh-agent-credentials:
            users:
                - '390bdc1f-73c6-457e-81de-9e794478e0e'
    builders:
        - config-file-provider:
            files:
              - file-id: '62cf0ccc-220e-4177-9eab-f39701bff8d7'
                target: 'camayoc/config.yaml'
        - copyartifact:
                project: qpc-master
                filter: quipucords.*.tar.gz
        - config-file-provider:
            files:
              - file-id: '{repo-file}'
                target: '${{WORKSPACE}}/{distro}-custom.repo'
        - shell: |
                export XDG_CONFIG_HOME=$PWD
                mkdir -p /home/jenkins/.ssh
                cp "${{ID_JENKINS_RSA}}" /home/jenkins/.ssh/id_rsa
                chmod 0600 /home/jenkins/.ssh/id_rsa

                echo "setup docker configuration"
                echo "OPTIONS=--log-driver=journald" > docker.conf
                echo "DOCKER_CERT_PATH=/etc/docker" >> docker.conf
                sudo cp docker.conf /etc/sysconfig/docker

                set +e # don't want to fail if epel is allready installed
                if [ "${{DISTRO}}" = "rhel7" ]; then
                        sudo cp ${{WORKSPACE}}/rhel7-custom.repo /etc/yum.repos.d/rhel7-rcm-internal.repo
                        wget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
                        sudo rpm -ivh epel-release-latest-7.noarch.rpm
                fi
                if [ "${{DISTRO}}" = "rhel6" ]; then
                        sudo cp ${{WORKSPACE}}/rhel6-custom.repo /etc/yum.repos.d/rhel6-rcm-internal.repo
                        wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
                        sudo rpm -ivh epel-release-6-8.noarch.rpm
                        sudo yum clean all
                        sudo yum-config-manager --disable base
                        sudo yum-config-manager --disable optional
                fi

                echo "Install python-pip"
                sudo dnf -y install python-pip

                set -e

                rm quipucords.*.tar.gz
                echo "load docker container from tarball"
                curl -k -O -sSL https://github.com/quipucords/quipucords/releases/download/${{RELEASE}}/quipucords.${{RELEASE}}.install.tar.gz

                echo "extract the installer into ${{WORKSPACE}}/install"
                tar -xvzf ${{WORKSPACE}}/quipucords.${{RELEASE}}.install.tar.gz

                echo "Execute install.sh to install"
                cd ${{WORKSPACE}}/install/
                sudo ${{WORKSPACE}}/install/install.sh -e server_install_dir=${{WORKSPACE}} -e use_supervisord=false

                # Docker log to check for supervisord
                sudo docker ps -a # For logging reasons
                sudo docker logs quipucords | grep -i "Running without supervisord"

                cd ${{WORKSPACE}}

                sudo pip install pexpect nose
                set +e
                nosetests --with-xunit --xunit-file=junit.xml ci/scripts/quipucords/master/install/test_install.py
                set -e

                # Archive server logs to aid in analyzing test failures
                cd ${{WORKSPACE}}
                tar -cvzf server-logs.tar.gz ${{WORKSPACE}}/log
    publishers:
        - junit:
            results: junit.xml
        - archive:
            artifacts: 'server-logs.tar.gz'
            allow-empty: false
        - mark-node-offline
