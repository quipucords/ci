- job-template:
    name: 'rho-nightly-remote-scan-{config}'
    node: 'f25-np'
    triggers:
        - timed: '{time}'
    scm:
        - git:
            url: https://github.com/quipucords/camayoc.git
            basedir: camayoc
            branches:
                - '*/master'
            skip-tag: true
        - git:
            url: https://github.com/quipucords/rho.git
            basedir: rho
            branches:
                - '*/master'
            skip-tag: true
    wrappers:
        - ssh-agent-credentials:
            users:
                - '390bdc1f-73c6-457e-81de-9e794478e0e'
    builders:
        - config-file-provider:
            files:
              - file-id: '{config-file-id}'
                target: 'camayoc/config.yaml'
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-3
            nature: shell
            command: |
                cd rho
                pip install -r requirements.txt
                cd -
                pip install ./camayoc[dev]

                cat > .coveragerc <<EOF
                [run]
                concurrency=
                    multiprocessing
                    thread
                data_file=${{PWD}}/.coverage
                source=
                    ${{PWD}}/rho/rho
                EOF

                export COVERAGE_PROCESS_START="${{PWD}}/.coveragerc"
                RHO="$(which rho)"
                sed -i '/#!/a import coverage; coverage.process_startup()' "${{RHO}}"

                # Link RHO ansible modules
                sudo mkdir -p /usr/share/ansible/rho/
                sudo ln -s "${{PWD}}/rho/rho_playbook.yml" /usr/share/ansible/rho/
                sudo ln -s "${{PWD}}/rho/library" /usr/share/ansible/rho/
                sudo ln -s "${{PWD}}/rho/roles" /usr/share/ansible/rho/
                export XDG_CONFIG_HOME=$PWD
                # begin work around for issue #15
                # see https://github.com/quipucords/ci/issues/15
                pip install ansible==2.3.2
                # end work around
                set +e
                pytest -v --junit-xml junit.xml camayoc/camayoc/tests/remote/
                set -e

                coverage combine
                coverage report
                coverage xml
    publishers:
        - junit:
            results: junit.xml
        - cobertura:
            fail-no-reports: true
            report-file: coverage.xml
            source-encoding: UTF_8
            targets:
                - line:
                    healthy: 80
                    unhealthy: 50
                    failing: 0
        - mark-node-offline
