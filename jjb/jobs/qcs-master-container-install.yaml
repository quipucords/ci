- job-template:
    name: 'qcs-master-container-install-{distro}'
    node: '{distro}-os'
    triggers:
        - timed: '@midnight'
    scm:
        - git:
            url: https://github.com/quipucords/ci.git
            basedir: ci
            skip-tag: true
            branches:
              - master
    wrappers:
        - inject:
            properties-content: |
                DISTRO={distro}
        - credentials-binding:
            - file:
                credential-id: 4c692211-c5e1-4354-8e1b-b9d0276c29d9
                variable: ID_JENKINS_RSA
        - ssh-agent-credentials:
            users:
                - '390bdc1f-73c6-457e-81de-9e794478e0e'
    builders:
        - config-file-provider:
            files:
              - file-id: '62cf0ccc-220e-4177-9eab-f39701bff8d7'
                target: 'camayoc/config.yaml'
        - copyartifact:
                project: qpc_docker_img_poll
                filter: quipucords.*.tar.gz
                target: ${WORKSPACE}/container/
                stable: true

        - shining-panda:
            build-environment: virtualenv
            python-version: Default-System-Python2
            nature: shell
            command: |
                export XDG_CONFIG_HOME=$PWD
                mkdir -p /home/jenkins/.ssh
                cp "${{ID_JENKINS_RSA}}" /home/jenkins/.ssh/id_rsa
                chmod 0600 /home/jenkins/.ssh/id_rsa

                echo "setup docker configuration"
                echo "OPTIONS=--log-driver=journald" > docker.conf
                echo "DOCKER_CERT_PATH=/etc/docker" >> docker.conf
                sudo cp docker.conf /etc/sysconfig/docker

                echo "extract the installer into ${{WORKSPACE}}/install"
                tar -xvzf ${{WORKSPACE}}/quipucords.install.tar.gz

                echo "copy container to installer packages directory"
                mkdir -p ${{WORKSPACE}}/install/packages
                mv quipucords.1.0.0.tar.gz	${{WORKSPACE}}/install/packages/

                echo "Execute ansible playbook to install"
                sudo ansible-playbook -v qpc_playbook.yml -e server_install_dir=${{WORKSPACE}}

                pip install pexpect nose
                set +e
                nosetests --with-xunit --xunit-file=junit.xml ci/scripts/quipucords/master/install/test_install.py
                set -e

                # Archive server logs to aid in analyzing test failures
                cd ${{WORKSPACE}}
                tar -cvzf server-logs.tar.gz ${{WORKSPACE}}/log
    publishers:
        - junit:
            results: junit.xml
        - archive:
            artifacts: 'server-logs.tar.gz'
            allow-empty: false
        - mark-node-offline
