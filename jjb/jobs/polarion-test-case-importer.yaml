- job:
    name: 'polarion-test-case-importer'
    node: 'f25-np'
    triggers:
        - timed: '@midnight'
    scm:
        - git:
            url: https://github.com/quipucords/camayoc.git
            branches:
                - '*/master'
            skip-tag: true
    wrappers:
        - inject-passwords:
            global: true
            mask-password-params: true
        - ssh-agent-credentials:
            users:
                - '390bdc1f-73c6-457e-81de-9e794478e0e'
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            clear: true
            nature: shell
            command: |
                rm -rf pylarion

                ssh-keyscan "$(echo ${PYLARION_REPO_URL} | cut -d: -f1 | cut -d@ -f2)" >> ~/.ssh/known_hosts
                git clone -b satelliteqe-pylarion --depth 1 "${PYLARION_REPO_URL}"

                # Install pylarion and its dependencies
                cd pylarion
                pip install -r requirements.txt
                pip install .
                cd ..

                # Install the latest version of betelgeuse.
                pip install betelgeuse

                #betelgeuse requirement \
                #    camayoc/tests/qcs \
                #    "${POLARION_PROJECT}"

                export PYTHONPATH="${PWD}"

                cat > betelgeuse_config.py <<EOF
                DEFAULT_APPROVERS_VALUE = '${POLARION_USERNAME}:approved'
                DEFAULT_STATUS_VALUE = 'approved'
                DEFAULT_SUBTYPE2_VALUE = '-'
                EOF

                betelgeuse --config-module "betelgeuse_config" test-case \
                    --response-property "camayoc=test-cases" \
                    --automation-script-format "https://github.com/quipucords/camayoc/blob/master/{path}#L{line_number}" \
                    camayoc/tests/qcs \
                    "${POLARION_PROJECT}" \
                    camayoc-test-cases.xml

                curl -k -u "${POLARION_USERNAME}:${POLARION_PASSWORD}" \
                    -X POST \
                    -F file=@camayoc-test-cases.xml \
                    "${POLARION_URL}import/testcase"
        - raw:
            xml: |
                <com.redhat.jenkins.plugins.ci.CIMessageSubscriberBuilder>
                  <providerName>Red Hat UMB</providerName>
                  <overrides>
                   <topic>Consumer.rh-jenkins-ci-plugin.3b39eb07-9b1a-4664-a4d2-07e6ac86b390.VirtualTopic.qe.ci.></topic>
                  </overrides>
                  <selector>camayoc = 'test-cases'</selector>
                  <variable/>
                  <checks/>
                  <timeout>60</timeout>
                </com.redhat.jenkins.plugins.ci.CIMessageSubscriberBuilder>
    publishers:
        - mark-node-offline
